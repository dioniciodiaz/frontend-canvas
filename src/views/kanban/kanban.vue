<template>
    <div class="card-scene">
        <Container
            orientation="horizontal"
            drag-handle-selector=".column-drag-handle"
            @drop="onColumnDrop($event)">
            <Draggable v-for="lane in lanes" :key="lane.id">
                <div class="card-container">
                    <div >
                        <span>&#x2630;</span>
                        {{ lane.name }}
                    </div>
          
                    <Container
                        :get-child-payload="getCardPayload(lane.id)"
                        group-name="col"
                        drag-class="card-ghost"
                        drop-class="card-ghost-drop"
                        @drop="(e) => onCardDrop(lane.id, e)">
                        <Draggable v-for="card in lane.cards" :key="card.id">
                            <div class="card" style="backgroundColor: azure">
                                <p>Name: {{ card.data.firstName }}</p>
                                <p>Last Name: {{ card.data.lastName }}</p>
                                <p>Email: {{ card.data.email }}</p>
                                <p>Phone: {{ card.data.phone }}</p>
              
                            </div>
                        </Draggable>
                    </Container>
                </div>
            </Draggable>
        </Container>
    </div>
</template>

<script>

import { Container, Draggable } from "vue-smooth-dnd";

const lanes = [
    {
        id: 0,
        name: "New Lead",
        cards: []
    },
    {
        id: 1,
        name: "Contacted",
        cards: []
    },
    {
        id: 2,
        name: "Appointment",
        cards: []
    },
    {
        id: 3,
        name: "Showroom",
        cards: []
    },
    {
        id: 4,
        name: "Demo",
        cards: []
    },
    {
        id: 5,
        name: "Desk",
        cards: []
    }
]


const baseDevUrl = "https://apidev.gewaer.io/v1/";


export default {
    name: "Kanban",
    components: {Container, Draggable},
    data() {
        return {
            lanes
        };
    },
    watch: {
        "$route": "fetchData"
    },
    created() {
        this.fetchData();
    },
    methods: {
        prepareLanes(data) {
            if (data == null) {
                return; 
            }
	
            data.forEach((value) => {
                let newObj = {
                    id: value.id,
                    data: {
                        firstName: value.firstname,
                        lastName: value.lastname,
                        email: value.email,
                        phone: value.phone,
                        description: value.description
                    }
                }

                this.lanes[Number(value.leads_status_id)].cards.push(newObj);
            });
        },
        fetchData() {
            axios({
                url: baseDevUrl + "leads?limit=10",
                method: "GET"
            }).then((response) => {
                this.prepareLanes(response.data);
            }).catch((error) => {
                this.$notify({
                    group: null,
                    title: "Error",
                    text: error.response.data.errors.message,
                    type: "error"
                });
            });
        },
        onCardDrop(columnId, dropResult) {
            const lane =  Object.assign([], this.lanes);
            const column = lane.filter(c => c.id === columnId)[0];
            const columnIndex = this.lanes.indexOf(column)

            const newColumn = Object.assign({}, column);

            if (dropResult.addedIndex !== null) {
                
                newColumn.cards = this.applyDrag(newColumn.cards, dropResult);

                let leadStatusId = dropResult.payload.id;
                let requestUrl = baseDevUrl + "leads/" + leadStatusId;
                axios.put(requestUrl, {"leads_status_id": columnId})
                    .catch((error) => {
                        console.log(error);
                    });
            } else if (dropResult.removedIndex !== null) {
                newColumn.cards = this.applyDrag(newColumn.cards, dropResult);                
            }

            lane.splice(columnIndex, 1, newColumn);
            this.lanes = lane;
        },
        getCardPayload(columnId) {
            return index => {
                return this.lanes.filter(p => p.id === columnId)[0].cards[index];
            }
        },
        applyDrag(arr, dragResult) {
            const { removedIndex, addedIndex, payload } = dragResult

            const result = [...arr];
            let itemToAdd = payload;

            if (removedIndex !== null) {
                itemToAdd = result.splice(removedIndex, 1)[0];
            }

            if (addedIndex !== null) {
                result.splice(addedIndex, 0, itemToAdd);
            }

            return result;
        }
    }
};

</script>

<style>

    /* Demo Styling: para que no se vea tan feo*/
    .draggable-item {
        height: 50px;
        line-height: 50px;
        text-align: center;
        width: 100%;
        display: block;
        background-color: #fff;
        outline: 0;
        border: 1px solid rgba(0, 0, 0, .125);
        margin-bottom: 2px;
        margin-top: 2px;
        cursor: default;
        user-select: none;
    }

    .draggable-item-horizontal {
        height: 300px;
        padding: 10px;
        line-height: 100px;
        text-align: center;
        /* width : 200px; */
        display: block;
        background-color: #fff;
        outline: 0;
        border: 1px solid rgba(0, 0, 0, .125);
        margin-right: 4px;
        cursor: default;
    }

    .dragging {
        background-color: yellow;
    }

    .card-scene {
        padding: 50px;
        /* background-color: #fff; */
    }

    .card-container {
        width: 320px;
        padding: 10px;
        margin: 5px;
        margin-right: 45px;
        background-color: #f3f3f3;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.12), 0 1px 1px rgba(0, 0, 0, 0.24);
    }

    .card {
        margin: 5px;
        /* border: 1px solid #ccc; */
        background-color: white;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.12), 0 1px 1px rgba(0, 0, 0, 0.24);
        padding: 10px;
    }

    .card-column-header {
        font-size: 18px;
    }

    .column-drag-handle {
        cursor: move;
        padding: 5px;
    }

    .card-ghost {
        transition: transform 0.18s ease;
        transform: rotateZ(5deg)
    }

    .card-ghost-drop {
        transition: transform 0.18s ease-in-out;
        transform: rotateZ(0deg)
    }

    .opacity-ghost {
        transition: all .18s ease;
        opacity: 0.8;
        /* transform: rotateZ(5deg); */
        background-color: cornflowerblue;
        box-shadow: 3px 3px 10px 3px rgba(0, 0, 0, 0.3);
    }

    .opacity-ghost-drop {
        opacity: 1;
        /* transform: rotateZ(0deg); */
        background-color: white;
        box-shadow: 3px 3px 10px 3px rgba(0, 0, 0, 0.0);
    }


    .form-demo {
        width: 650px;
        margin-left: auto;
        margin-right: auto;
        margin-top: 50px;
        display: flex
    }

    .form {
        flex: 3;
        /* width: 500px; */
        /* background-color: #f3f3f3; */
        border: 1px solid rgba(0, 0, 0, .125);
        border-radius: 6px;
        box-shadow: 3px 3px 3px rgba(0, 0, 0, 0.08), 0px 3px 3px rgba(0, 0, 0, 0.08);
    }

    .form-fields-panel {
        flex: 1;
        margin-right: 50px;
    }

    .form-ghost {
        transition: 0.18s ease;
        box-shadow: 1px 1px 5px 2px rgba(0, 0, 0, 0.08);
    }

    .form-ghost-drop {
        box-shadow: 0 0 2px 5px rgba(0, 0, 0, 0.0);
    }

</style>